---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { DEFAULT_IMAGES, getOptimizedImageUrl } from '../../utils/images';
import RelatedContent from '../../components/RelatedContent.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import SidebarCTA from '../../components/SidebarCTA.astro';

export async function getStaticPaths() {
  const topics = await getCollection('topics');
  return topics.map(topic => ({
    params: { slug: topic.slug },
    props: { topic },
  }));
}

const { topic } = Astro.props;
const { Content, headings } = await topic.render();

// Get related posts that have this topic as their parent
const posts = await getCollection('posts', (post) => {
  return !post.data.draft && post.data.parent_topic?.slug === topic.slug;
});

// Get related articles in this topic
const articles = await getCollection('articles', (article) => 
  !article.data.draft && article.data.topic === topic.slug
);
---

<Layout title={topic.data.title} description={topic.data.description}>
  <main class="max-w-7xl mx-auto px-4 pb-20">
    <article class="mb-12">
      <div class="mb-8">
        <img
          src={getOptimizedImageUrl(topic.data.topicImage?.src || DEFAULT_IMAGES.post.src, 1200)}
          alt={topic.data.topicImage?.alt || `${topic.data.title} featured image`}
          width={topic.data.topicImage?.width || DEFAULT_IMAGES.post.width}
          height={topic.data.topicImage?.height || DEFAULT_IMAGES.post.height}
          class="w-full aspect-video object-cover rounded-xl shadow-lg"
        />
      </div>

      <header class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">{topic.data.title}</h1>
        <p class="text-xl text-base-content/80 max-w-2xl mx-auto">{topic.data.description}</p>
      </header>

      <div class="lg:grid lg:grid-cols-[250px_1fr] lg:gap-12">
        <aside class="hidden lg:block">
          <div class="sticky top-4">
            <div class="flex flex-col gap-12">
              <TableOfContents 
                headings={headings} 
                hasFAQ={!!topic.data.faq}
              />
              <SidebarCTA ctaId="post_content" />
            </div>
          </div>
        </aside>
        <div class="prose prose-lg max-w-4xl mx-auto mb-16">
          <Content />

          {topic.data.sections && (
            <div class="mb-12">
              {topic.data.sections.map((section) => (
                <div class="mb-8">
                  <h2 class="text-2xl font-bold mb-4">{section.title}</h2>
                  <div class="prose" set:html={section.content} />
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      <RelatedContent 
        content={posts} 
        title="Related Posts" 
      />

      <RelatedContent 
        content={articles} 
        title="Related Articles" 
      />
    </article>
  </main>
</Layout>
