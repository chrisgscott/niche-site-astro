---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { Image } from "astro:assets";
import { DEFAULT_IMAGES, getOptimizedImageUrl } from '../../utils/images';

export const getStaticPaths = async () => {
  const articles = await getCollection("articles");
  const path = articles.map((article) => {
    return {
      params: {
        slug: article.slug,
      },
      props: {
        article,
      },
    };
  });
  return path;
};

type Props = {
  article: CollectionEntry<"articles">;
};

const { article } = Astro.props;
const { Content } = await article.render();

// Get the parent topic if it exists
const topics = article.data.topic ? 
  await getCollection("topics", (topic) => 
    topic.data.links.articles.includes(article.slug)
  ) : [];
const parentTopic = topics[0];
---

<Layout title={article.data.title} description={article.data.description}>
  <article class="prose prose-lg lg:prose-xl mx-auto px-4 py-8">
    <div class="not-prose mb-8">
      {article.data.image && (
        <img
          src={getOptimizedImageUrl(article.data.image, 1200)}
          alt={article.data.title}
          class="w-full aspect-video object-cover rounded-xl shadow-lg"
        />
      )}
    </div>

    <header class="text-center mb-12">
      <div class="flex items-center justify-center gap-4 mb-4">
        {article.data.schema && (
          <div class="badge badge-outline">{article.data.schema}</div>
        )}
      </div>
      <h1 class="mb-4">{article.data.title}</h1>
      <p class="text-xl text-base-content/80 mb-6">{article.data.description}</p>
    </header>

    <div class="prose prose-lg max-w-2xl">
      <Content />
    </div>

    {/* FAQ Section */}
    {article.data.faq && article.data.faq.length > 0 && (
      <div class="max-w-2xl w-full mt-12">
        <h2 class="text-3xl font-bold mb-6">Frequently Asked Questions</h2>
        <div class="space-y-4">
          {article.data.faq.map((item) => (
            <div class="collapse collapse-plus bg-base-200">
              <input type="radio" name="faq-accordion" /> 
              <div class="collapse-title text-xl font-medium">
                {item.question}
              </div>
              <div class="collapse-content">
                <p>{item.answer}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    {/* Variations */}
    {article.data.variations && Object.keys(article.data.variations).length > 0 && (
      <div class="max-w-2xl w-full mt-12">
        <h2 class="text-3xl font-bold mb-6">Available Options</h2>
        {Object.entries(article.data.variations).map(([category, options]) => (
          <div class="mb-6">
            <h3 class="text-xl font-semibold mb-3 capitalize">{category}</h3>
            <div class="flex flex-wrap gap-2">
              {options.map((option) => (
                <div class="badge badge-outline">{option}</div>
              ))}
            </div>
          </div>
        ))}
      </div>
    )}
  </article>
</Layout>
